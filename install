#!/usr/bin/env bash

CLASHTUI_CONFIG_DIR=${XDG_CONFIG_HOME:-$HOME/.config}/clashtui
CLASHTUI_INSTALL_DIR=/opt/clashtui

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
  echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1" >&2
}

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

create_mihomo_user() {
  if ! id "mihomo" &>/dev/null; then
    log_info "Creating mihomo user and group..."
    sudo groupadd --system mihomo
    sudo useradd --system --no-create-home --gid mihomo --shell /bin/false mihomo
  else
    log_info "mihomo user already exists"
  fi
}

create_mihomo_systemd_unit() {
  log_info "Creating mihomo systemd unit..."

  sudo tee "$CLASHTUI_INSTALL_DIR/clashtui_mihomo.service" >/dev/null <<'EOF'
[Unit]
Description=mihomo Daemon, Another Clash Kernel.
After=network.target NetworkManager.service systemd-networkd.service iwd.service

[Service]
Type=simple
User=mihomo
Group=mihomo
LimitNPROC=500
LimitNOFILE=1000000
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_RAW CAP_NET_BIND_SERVICE CAP_SYS_TIME CAP_SYS_PTRACE CAP_DAC_READ_SEARCH CAP_DAC_OVERRIDE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_RAW CAP_NET_BIND_SERVICE CAP_SYS_TIME CAP_SYS_PTRACE CAP_DAC_READ_SEARCH CAP_DAC_OVERRIDE
Restart=always
ExecStartPre=/usr/bin/sleep 1s
ExecStart=/opt/clashtui/mihomo -d /opt/clashtui/mihomo_config
ExecReload=/bin/kill -HUP $MAINPID

[Install]
WantedBy=multi-user.target
EOF

  sudo ln -s $CLASHTUI_INSTALL_DIR/clashtui_mihomo.service /etc/systemd/system/
  sudo systemctl daemon-reload
}

create_clashtui_config() {
  log_info "Creating clashtui config.yaml..."

  tee "$CLASHTUI_CONFIG_DIR/config.yaml" >/dev/null <<'EOF'
basic:
  clash_config_dir: '/opt/clashtui/mihomo_config'
  clash_bin_path: '/opt/clashtui/mihomo'
  clash_config_path: '/opt/clashtui/mihomo_config/config.yaml'
  timeout: null
service:
  clash_srv_name: 'clashtui_mihomo'
  is_user: false
extra:
  edit_cmd:
  open_dir_cmd:
EOF

  tee "$CLASHTUI_CONFIG_DIR/basic_clash_config.yaml" >/dev/null <<'EOF'
mixed-port: 7890
mode: rule
log-level: info
external-controller: 127.0.0.1:9090
EOF

  sudo cp "$CLASHTUI_CONFIG_DIR/basic_clash_config.yaml" "$CLASHTUI_INSTALL_DIR/mihomo_config/config.yaml"

  mkdir "$CLASHTUI_CONFIG_DIR/profiles"
  mkdir "$CLASHTUI_CONFIG_DIR/templates"
  touch "$CLASHTUI_CONFIG_DIR/templates/template_proxy_providers"

  echo -n "Do you want to download templates? (y/N): "
  read -r response
  if [ "$response" = "y" ] || [ "$response" = "Y" ]; then
    log_info "Downloading templates..."
    curl -o $CLASHTUI_CONFIG_DIR/templates/common_tpl.yaml https://raw.githubusercontent.com/JohanChane/clashtui/refs/heads/main/Example/templates/common_tpl.yaml
    curl -o $CLASHTUI_CONFIG_DIR/templates/generic_tpl.yaml https://raw.githubusercontent.com/JohanChane/clashtui/refs/heads/main/Example/templates/generic_tpl.yaml
    curl -o $CLASHTUI_CONFIG_DIR/templates/generic_tpl_with_all.yaml https://raw.githubusercontent.com/JohanChane/clashtui/refs/heads/main/Example/templates/generic_tpl_with_all.yaml
    curl -o $CLASHTUI_CONFIG_DIR/templates/generic_tpl_with_filter.yaml https://raw.githubusercontent.com/JohanChane/clashtui/refs/heads/main/Example/templates/generic_tpl_with_filter.yaml
    curl -o $CLASHTUI_CONFIG_DIR/templates/generic_tpl_with_rulest.yaml https://raw.githubusercontent.com/JohanChane/clashtui/refs/heads/main/Example/templates/generic_tpl_with_ruleset.yaml
  fi
}

detect_architecture() {
  local arch
  arch=$(uname -m)

  case "$arch" in
  x86_64 | amd64)
    echo "amd64"
    ;;
  aarch64 | arm64)
    echo "arm64"
    ;;
  armv7l | armhf)
    echo "armv7"
    ;;
  armv6l)
    echo "armv6"
    ;;
  i386 | i686)
    echo "386"
    ;;
  *)
    echo "unsupported"
    ;;
  esac
}

detect_os() {
  local os
  os=$(uname -s | tr '[:upper:]' '[:lower:]')

  case "$os" in
  linux)
    echo "linux"
    ;;
  darwin)
    echo "darwin"
    ;;
  freebsd)
    echo "freebsd"
    ;;
  *)
    echo "unsupported"
    ;;
  esac
}

download_mihomo() {
  local arch=$(detect_architecture)
  local os=$(detect_os)
  local download_url
  local temp_dir=$(mktemp -d)
  local latest_version=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

  if [ "$arch" = "unsupported" ] || [ "$os" = "unsupported" ]; then
    log_error "Unsupported architecture ($(uname -m)) or OS ($(uname -s))"
    rm -rf "$temp_dir"
    return 1
  fi

  download_url="https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-${os}-${arch}-${latest_version}.gz"

  log_info "Detected: OS=$os, Arch=$arch, LatestVersion=$latest_version, download_url=$download_url"

  curl -L "$download_url" -o "$temp_dir/mihomo.gz"
  gunzip -c "$temp_dir/mihomo.gz" >"$temp_dir/mihomo"

  local binary_path
  if [ -f "$temp_dir/mihomo" ]; then
    binary_path="$temp_dir/mihomo"
  else
    log_error "Could not find binary in the downloaded archive"
    rm -rf "$temp_dir"
    return 1
  fi

  sudo install -m 755 "$binary_path" "$CLASHTUI_INSTALL_DIR/mihomo"
  log_info "Successfully installed mihomo to: $CLASHTUI_INSTALL_DIR/mihomo"
  rm -rf "$temp_dir"
}

install_mihomo() {
  if command_exists mihomo; then
    sudo ln -s "$(which mihomo)" $CLASHTUI_INSTALL_DIR/mihomo
  elif command_exists clash-meta; then
    sudo ln -s "$(which clash-meta)" $CLASHTUI_INSTALL_DIR/mihomo
  else
    download_mihomo
  fi

  create_mihomo_user
  sudo gpasswd -a $USER mihomo

  sudo chown mihomo:mihomo "$CLASHTUI_INSTALL_DIR/mihomo_config"
  create_mihomo_systemd_unit
}

install_clashtui() {
  if ! command_exists clashtui; then
    download_clashtui
  fi

  create_clashtui_config
}

download_clashtui() {
  local arch=$(detect_architecture)
  local os=$(detect_os)
  local download_url
  local temp_dir=$(mktemp -d)
  local latest_version=$(curl -s "https://api.github.com/repos/JohanChane/clashtui/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

  if [ "$arch" = "unsupported" ] || [ "$os" = "unsupported" ]; then
    log_error "Unsupported architecture ($(uname -m)) or OS ($(uname -s))"
    rm -rf "$temp_dir"
    return 1
  fi

  download_url="https://github.com/JohanChane/clashtui/releases/latest/download/clashtui-${os}-${arch}-${latest_version}.gz"

  log_info "Detected: OS=$os, Arch=$arch, LatestVersion=$latest_version, download_url=$download_url"

  curl -L "$download_url" -o "$temp_dir/clashtui.gz"
  gunzip -c "$temp_dir/clashtui.gz" >"$temp_dir/clashtui"

  local binary_path
  if [ -f "$temp_dir/clashtui" ]; then
    binary_path="$temp_dir/clashtui"
  else
    log_error "Could not find binary in the downloaded archive"
    rm -rf "$temp_dir"
    return 1
  fi

  sudo install -m 755 "$binary_path" "$CLASHTUI_INSTALL_DIR/clashtui"
  sudo ln -s "$CLASHTUI_INSTALL_DIR/clashtui" /usr/local/bin/clashtui
  log_info "Successfully installed clashtui to: $CLASHTUI_INSTALL_DIR/clashtui"
  rm -rf "$temp_dir"
}

uninstall() {
  echo "Please make sure the mihomo daemon has been stopped before uninstallation."
  echo -n "Continue with uninstallation? (y/N): "
  read -r response
  if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
    echo "Uninstallation cancelled."
    return 1
  fi

  sudo rm -f /etc/systemd/system/clashtui_mihomo.service
  sudo systemctl daemon-reload
  sudo rm -f /usr/local/bin/clashtui
  sudo rm -rf /opt/clashtui

  echo "[Optional] Delete the mihomo user and group"
  echo "  sudo gpasswd -d $USER mihomo"
  echo "  sudo userdel mihomo"
}

show_help() {
  echo "Usage: $0 [OPTION]"
  echo "Install or uninstall clashtui"
  echo
  echo "Options:"
  echo "  -h, --help       Show this help message and exit"
  echo "  -u, --uninstall  Uninstall clashtui"
  echo
  echo "If no options are provided, the script will install clashtui."
}

main() {
  while [[ $# -gt 0 ]]; do
    case $1 in
    -u | --uninstall)
      uninstall
      return 0
      ;;
    -h | --help)
      show_help
      return 0
      ;;
    *)
      log_error "Unknown option"
      show_help
      return 1
      ;;
    esac
  done

  sudo mkdir -p "$CLASHTUI_INSTALL_DIR/mihomo_config"
  mkdir -p "$CLASHTUI_CONFIG_DIR/clashtui"

  install_mihomo
  install_clashtui

  log_warn 'Please log out and log back in for the group file permissions to take effect'
}

main "$@"
